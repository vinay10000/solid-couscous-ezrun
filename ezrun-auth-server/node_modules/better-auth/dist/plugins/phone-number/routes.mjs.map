{"version":3,"file":"routes.mjs","names":["user"],"sources":["../../../src/plugins/phone-number/routes.ts"],"sourcesContent":["import { createAuthEndpoint } from \"@better-auth/core/api\";\nimport { BASE_ERROR_CODES } from \"@better-auth/core/error\";\nimport { APIError } from \"better-call\";\nimport * as z from \"zod\";\nimport { getSessionFromCtx } from \"../../api\";\nimport { setSessionCookie } from \"../../cookies\";\nimport { generateRandomString } from \"../../crypto/random\";\nimport { parseUserOutput } from \"../../db/schema\";\nimport type { User } from \"../../types\";\nimport { getDate } from \"../../utils/date\";\nimport { PHONE_NUMBER_ERROR_CODES } from \"./error-codes\";\nimport type { PhoneNumberOptions, UserWithPhoneNumber } from \"./types\";\n\nexport type RequiredPhoneNumberOptions = PhoneNumberOptions & {\n\texpiresIn: number;\n\totpLength: number;\n\tphoneNumber: string;\n\tphoneNumberVerified: string;\n\tcode: string;\n\tcreatedAt: string;\n};\n\nconst signInPhoneNumberBodySchema = z.object({\n\tphoneNumber: z.string().meta({\n\t\tdescription: 'Phone number to sign in. Eg: \"+1234567890\"',\n\t}),\n\tpassword: z.string().meta({\n\t\tdescription: \"Password to use for sign in.\",\n\t}),\n\trememberMe: z\n\t\t.boolean()\n\t\t.meta({\n\t\t\tdescription: \"Remember the session. Eg: true\",\n\t\t})\n\t\t.optional(),\n});\n\n/**\n * ### Endpoint\n *\n * POST `/sign-in/phone-number`\n *\n * ### API Methods\n *\n * **server:**\n * `auth.api.signInPhoneNumber`\n *\n * **client:**\n * `authClient.signIn.phoneNumber`\n *\n * @see [Read our docs to learn more.](https://better-auth.com/docs/plugins/phone-number#api-method-sign-in-phone-number)\n */\nexport const signInPhoneNumber = (opts: RequiredPhoneNumberOptions) =>\n\tcreateAuthEndpoint(\n\t\t\"/sign-in/phone-number\",\n\t\t{\n\t\t\tmethod: \"POST\",\n\t\t\tbody: signInPhoneNumberBodySchema,\n\t\t\tmetadata: {\n\t\t\t\topenapi: {\n\t\t\t\t\tsummary: \"Sign in with phone number\",\n\t\t\t\t\tdescription: \"Use this endpoint to sign in with phone number\",\n\t\t\t\t\tresponses: {\n\t\t\t\t\t\t200: {\n\t\t\t\t\t\t\tdescription: \"Success\",\n\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\t\tuser: {\n\t\t\t\t\t\t\t\t\t\t\t\t$ref: \"#/components/schemas/User\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\tsession: {\n\t\t\t\t\t\t\t\t\t\t\t\t$ref: \"#/components/schemas/Session\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t\t400: {\n\t\t\t\t\t\t\tdescription: \"Invalid phone number or password\",\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t\tasync (ctx) => {\n\t\t\tconst { password, phoneNumber } = ctx.body;\n\n\t\t\tif (opts.phoneNumberValidator) {\n\t\t\t\tconst isValidNumber = await opts.phoneNumberValidator(\n\t\t\t\t\tctx.body.phoneNumber,\n\t\t\t\t);\n\t\t\t\tif (!isValidNumber) {\n\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\tmessage: PHONE_NUMBER_ERROR_CODES.INVALID_PHONE_NUMBER,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tconst user = await ctx.context.adapter.findOne<UserWithPhoneNumber>({\n\t\t\t\tmodel: \"user\",\n\t\t\t\twhere: [\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"phoneNumber\",\n\t\t\t\t\t\tvalue: phoneNumber,\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t});\n\t\t\tif (!user) {\n\t\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\t\tmessage: PHONE_NUMBER_ERROR_CODES.INVALID_PHONE_NUMBER_OR_PASSWORD,\n\t\t\t\t});\n\t\t\t}\n\t\t\tif (opts.requireVerification) {\n\t\t\t\tif (!user.phoneNumberVerified) {\n\t\t\t\t\tconst otp = generateOTP(opts.otpLength);\n\t\t\t\t\tawait ctx.context.internalAdapter.createVerificationValue({\n\t\t\t\t\t\tvalue: otp,\n\t\t\t\t\t\tidentifier: phoneNumber,\n\t\t\t\t\t\texpiresAt: getDate(opts.expiresIn, \"sec\"),\n\t\t\t\t\t});\n\t\t\t\t\tif (opts.sendOTP) {\n\t\t\t\t\t\tawait ctx.context.runInBackgroundOrAwait(\n\t\t\t\t\t\t\topts.sendOTP(\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tphoneNumber,\n\t\t\t\t\t\t\t\t\tcode: otp,\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\tctx,\n\t\t\t\t\t\t\t),\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\t\t\tmessage: PHONE_NUMBER_ERROR_CODES.PHONE_NUMBER_NOT_VERIFIED,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t\tconst accounts = await ctx.context.internalAdapter.findAccountByUserId(\n\t\t\t\tuser.id,\n\t\t\t);\n\t\t\tconst credentialAccount = accounts.find(\n\t\t\t\t(a) => a.providerId === \"credential\",\n\t\t\t);\n\t\t\tif (!credentialAccount) {\n\t\t\t\tctx.context.logger.error(\"Credential account not found\", {\n\t\t\t\t\tphoneNumber,\n\t\t\t\t});\n\t\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\t\tmessage: PHONE_NUMBER_ERROR_CODES.INVALID_PHONE_NUMBER_OR_PASSWORD,\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst currentPassword = credentialAccount?.password;\n\t\t\tif (!currentPassword) {\n\t\t\t\tctx.context.logger.error(\"Password not found\", { phoneNumber });\n\t\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\t\tmessage: PHONE_NUMBER_ERROR_CODES.UNEXPECTED_ERROR,\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst validPassword = await ctx.context.password.verify({\n\t\t\t\thash: currentPassword,\n\t\t\t\tpassword,\n\t\t\t});\n\t\t\tif (!validPassword) {\n\t\t\t\tctx.context.logger.error(\"Invalid password\");\n\t\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\t\tmessage: PHONE_NUMBER_ERROR_CODES.INVALID_PHONE_NUMBER_OR_PASSWORD,\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst session = await ctx.context.internalAdapter.createSession(\n\t\t\t\tuser.id,\n\t\t\t\tctx.body.rememberMe === false,\n\t\t\t);\n\t\t\tif (!session) {\n\t\t\t\tctx.context.logger.error(\"Failed to create session\");\n\t\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\t\tmessage: BASE_ERROR_CODES.FAILED_TO_CREATE_SESSION,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tawait setSessionCookie(\n\t\t\t\tctx,\n\t\t\t\t{\n\t\t\t\t\tsession,\n\t\t\t\t\tuser: user,\n\t\t\t\t},\n\t\t\t\tctx.body.rememberMe === false,\n\t\t\t);\n\t\t\treturn ctx.json({\n\t\t\t\ttoken: session.token,\n\t\t\t\tuser: parseUserOutput(ctx.context.options, user),\n\t\t\t});\n\t\t},\n\t);\n\nconst sendPhoneNumberOTPBodySchema = z.object({\n\tphoneNumber: z.string().meta({\n\t\tdescription: 'Phone number to send OTP. Eg: \"+1234567890\"',\n\t}),\n});\n\n/**\n * ### Endpoint\n *\n * POST `/phone-number/send-otp`\n *\n * ### API Methods\n *\n * **server:**\n * `auth.api.sendPhoneNumberOTP`\n *\n * **client:**\n * `authClient.phoneNumber.sendOtp`\n *\n * @see [Read our docs to learn more.](https://better-auth.com/docs/plugins/phone-number#api-method-phone-number-send-otp)\n */\nexport const sendPhoneNumberOTP = (opts: RequiredPhoneNumberOptions) =>\n\tcreateAuthEndpoint(\n\t\t\"/phone-number/send-otp\",\n\t\t{\n\t\t\tmethod: \"POST\",\n\t\t\tbody: sendPhoneNumberOTPBodySchema,\n\t\t\tmetadata: {\n\t\t\t\topenapi: {\n\t\t\t\t\tsummary: \"Send OTP to phone number\",\n\t\t\t\t\tdescription: \"Use this endpoint to send OTP to phone number\",\n\t\t\t\t\tresponses: {\n\t\t\t\t\t\t200: {\n\t\t\t\t\t\t\tdescription: \"Success\",\n\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\t\tmessage: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t\tasync (ctx) => {\n\t\t\tif (!opts?.sendOTP) {\n\t\t\t\tctx.context.logger.warn(\"sendOTP not implemented\");\n\t\t\t\tthrow new APIError(\"NOT_IMPLEMENTED\", {\n\t\t\t\t\tmessage: PHONE_NUMBER_ERROR_CODES.SEND_OTP_NOT_IMPLEMENTED,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tif (opts.phoneNumberValidator) {\n\t\t\t\tconst isValidNumber = await opts.phoneNumberValidator(\n\t\t\t\t\tctx.body.phoneNumber,\n\t\t\t\t);\n\t\t\t\tif (!isValidNumber) {\n\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\tmessage: PHONE_NUMBER_ERROR_CODES.INVALID_PHONE_NUMBER,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tconst code = generateOTP(opts.otpLength);\n\t\t\tawait ctx.context.internalAdapter.createVerificationValue({\n\t\t\t\tvalue: `${code}:0`,\n\t\t\t\tidentifier: ctx.body.phoneNumber,\n\t\t\t\texpiresAt: getDate(opts.expiresIn, \"sec\"),\n\t\t\t});\n\t\t\tawait ctx.context.runInBackgroundOrAwait(\n\t\t\t\topts.sendOTP(\n\t\t\t\t\t{\n\t\t\t\t\t\tphoneNumber: ctx.body.phoneNumber,\n\t\t\t\t\t\tcode,\n\t\t\t\t\t},\n\t\t\t\t\tctx,\n\t\t\t\t),\n\t\t\t);\n\t\t\treturn ctx.json({ message: \"code sent\" });\n\t\t},\n\t);\n\nconst verifyPhoneNumberBodySchema = z.object({\n\t/**\n\t * Phone number\n\t */\n\tphoneNumber: z.string().meta({\n\t\tdescription: 'Phone number to verify. Eg: \"+1234567890\"',\n\t}),\n\t/**\n\t * OTP code\n\t */\n\tcode: z.string().meta({\n\t\tdescription: 'OTP code. Eg: \"123456\"',\n\t}),\n\t/**\n\t * Disable session creation after verification\n\t * @default false\n\t */\n\tdisableSession: z\n\t\t.boolean()\n\t\t.meta({\n\t\t\tdescription: \"Disable session creation after verification. Eg: false\",\n\t\t})\n\t\t.optional(),\n\t/**\n\t * This checks if there is a session already\n\t * and updates the phone number with the provided\n\t * phone number\n\t */\n\tupdatePhoneNumber: z\n\t\t.boolean()\n\t\t.meta({\n\t\t\tdescription:\n\t\t\t\t\"Check if there is a session and update the phone number. Eg: true\",\n\t\t})\n\t\t.optional(),\n});\n\n/**\n * ### Endpoint\n *\n * POST `/phone-number/verify`\n *\n * ### API Methods\n *\n * **server:**\n * `auth.api.verifyPhoneNumber`\n *\n * **client:**\n * `authClient.phoneNumber.verify`\n *\n * @see [Read our docs to learn more.](https://better-auth.com/docs/plugins/phone-number#api-method-phone-number-verify)\n */\nexport const verifyPhoneNumber = (opts: RequiredPhoneNumberOptions) =>\n\tcreateAuthEndpoint(\n\t\t\"/phone-number/verify\",\n\t\t{\n\t\t\tmethod: \"POST\",\n\t\t\tbody: verifyPhoneNumberBodySchema,\n\t\t\tmetadata: {\n\t\t\t\topenapi: {\n\t\t\t\t\tsummary: \"Verify phone number\",\n\t\t\t\t\tdescription: \"Use this endpoint to verify phone number\",\n\t\t\t\t\tresponses: {\n\t\t\t\t\t\t\"200\": {\n\t\t\t\t\t\t\tdescription: \"Phone number verified successfully\",\n\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\t\tstatus: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"boolean\",\n\t\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\"Indicates if the verification was successful\",\n\t\t\t\t\t\t\t\t\t\t\t\tenum: [true],\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\ttoken: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\"Session token if session is created, null if disableSession is true or no session is created\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\tuser: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\t\t\t\tid: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"Unique identifier of the user\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t\temail: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tformat: \"email\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"User's email address\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t\temailVerified: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"boolean\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"Whether the email is verified\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t\tname: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"User's name\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t\timage: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tformat: \"uri\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"User's profile image URL\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t\tphoneNumber: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"User's phone number\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t\tphoneNumberVerified: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"boolean\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"Whether the phone number is verified\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t\tcreatedAt: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tformat: \"date-time\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"Timestamp when the user was created\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t\tupdatedAt: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tformat: \"date-time\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"Timestamp when the user was last updated\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\trequired: [\n\t\t\t\t\t\t\t\t\t\t\t\t\t\"id\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\"phoneNumber\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\"phoneNumberVerified\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\"createdAt\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\"updatedAt\",\n\t\t\t\t\t\t\t\t\t\t\t\t],\n\t\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\"User object with phone number details, null if no user is created or found\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\trequired: [\"status\"],\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t\t400: {\n\t\t\t\t\t\t\tdescription: \"Invalid OTP\",\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t\tasync (ctx) => {\n\t\t\tif (opts?.verifyOTP) {\n\t\t\t\t// Use custom verifyOTP if provided\n\t\t\t\tconst isValid = await opts.verifyOTP(\n\t\t\t\t\t{\n\t\t\t\t\t\tphoneNumber: ctx.body.phoneNumber,\n\t\t\t\t\t\tcode: ctx.body.code,\n\t\t\t\t\t},\n\t\t\t\t\tctx,\n\t\t\t\t);\n\n\t\t\t\tif (!isValid) {\n\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\tmessage: PHONE_NUMBER_ERROR_CODES.INVALID_OTP,\n\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t\t// Clean up verification value\n\t\t\t\tconst otp = await ctx.context.internalAdapter.findVerificationValue(\n\t\t\t\t\tctx.body.phoneNumber,\n\t\t\t\t);\n\t\t\t\tif (otp) {\n\t\t\t\t\tawait ctx.context.internalAdapter.deleteVerificationValue(otp.id);\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\t// Default internal verification logic\n\t\t\t\tconst otp = await ctx.context.internalAdapter.findVerificationValue(\n\t\t\t\t\tctx.body.phoneNumber,\n\t\t\t\t);\n\n\t\t\t\tif (!otp || otp.expiresAt < new Date()) {\n\t\t\t\t\tif (otp && otp.expiresAt < new Date()) {\n\t\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\t\tmessage: PHONE_NUMBER_ERROR_CODES.OTP_EXPIRED,\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\tmessage: PHONE_NUMBER_ERROR_CODES.OTP_NOT_FOUND,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\tconst [otpValue, attempts] = otp.value.split(\":\");\n\t\t\t\tconst allowedAttempts = opts?.allowedAttempts || 3;\n\t\t\t\tif (attempts && parseInt(attempts) >= allowedAttempts) {\n\t\t\t\t\tawait ctx.context.internalAdapter.deleteVerificationValue(otp.id);\n\t\t\t\t\tthrow new APIError(\"FORBIDDEN\", {\n\t\t\t\t\t\tmessage: PHONE_NUMBER_ERROR_CODES.TOO_MANY_ATTEMPTS,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\tif (otpValue !== ctx.body.code) {\n\t\t\t\t\tawait ctx.context.internalAdapter.updateVerificationValue(otp.id, {\n\t\t\t\t\t\tvalue: `${otpValue}:${parseInt(attempts || \"0\") + 1}`,\n\t\t\t\t\t});\n\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\tmessage: PHONE_NUMBER_ERROR_CODES.INVALID_OTP,\n\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t\tawait ctx.context.internalAdapter.deleteVerificationValue(otp.id);\n\t\t\t}\n\n\t\t\tif (ctx.body.updatePhoneNumber) {\n\t\t\t\tconst session = await getSessionFromCtx(ctx);\n\t\t\t\tif (!session) {\n\t\t\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\t\t\tmessage: BASE_ERROR_CODES.USER_NOT_FOUND,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\tconst existingUser =\n\t\t\t\t\tawait ctx.context.adapter.findMany<UserWithPhoneNumber>({\n\t\t\t\t\t\tmodel: \"user\",\n\t\t\t\t\t\twhere: [\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tfield: \"phoneNumber\",\n\t\t\t\t\t\t\t\tvalue: ctx.body.phoneNumber,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t],\n\t\t\t\t\t});\n\t\t\t\tif (existingUser.length) {\n\t\t\t\t\tthrow ctx.error(\"BAD_REQUEST\", {\n\t\t\t\t\t\tmessage: PHONE_NUMBER_ERROR_CODES.PHONE_NUMBER_EXIST,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\tconst user =\n\t\t\t\t\tawait ctx.context.internalAdapter.updateUser<UserWithPhoneNumber>(\n\t\t\t\t\t\tsession.user.id,\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t[opts.phoneNumber]: ctx.body.phoneNumber,\n\t\t\t\t\t\t\t[opts.phoneNumberVerified]: true,\n\t\t\t\t\t\t},\n\t\t\t\t\t);\n\t\t\t\treturn ctx.json({\n\t\t\t\t\tstatus: true,\n\t\t\t\t\ttoken: session.session.token,\n\t\t\t\t\tuser: parseUserOutput(ctx.context.options, user),\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tlet user = await ctx.context.adapter.findOne<UserWithPhoneNumber>({\n\t\t\t\tmodel: \"user\",\n\t\t\t\twhere: [\n\t\t\t\t\t{\n\t\t\t\t\t\tvalue: ctx.body.phoneNumber,\n\t\t\t\t\t\tfield: opts.phoneNumber,\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t});\n\t\t\tif (!user) {\n\t\t\t\tif (opts?.signUpOnVerification) {\n\t\t\t\t\tuser =\n\t\t\t\t\t\tawait ctx.context.internalAdapter.createUser<UserWithPhoneNumber>({\n\t\t\t\t\t\t\temail: opts.signUpOnVerification.getTempEmail(\n\t\t\t\t\t\t\t\tctx.body.phoneNumber,\n\t\t\t\t\t\t\t),\n\t\t\t\t\t\t\tname: opts.signUpOnVerification.getTempName\n\t\t\t\t\t\t\t\t? opts.signUpOnVerification.getTempName(ctx.body.phoneNumber)\n\t\t\t\t\t\t\t\t: ctx.body.phoneNumber,\n\t\t\t\t\t\t\t[opts.phoneNumber]: ctx.body.phoneNumber,\n\t\t\t\t\t\t\t[opts.phoneNumberVerified]: true,\n\t\t\t\t\t\t});\n\t\t\t\t\tif (!user) {\n\t\t\t\t\t\tthrow new APIError(\"INTERNAL_SERVER_ERROR\", {\n\t\t\t\t\t\t\tmessage: BASE_ERROR_CODES.FAILED_TO_CREATE_USER,\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tuser =\n\t\t\t\t\tawait ctx.context.internalAdapter.updateUser<UserWithPhoneNumber>(\n\t\t\t\t\t\tuser.id,\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t[opts.phoneNumberVerified]: true,\n\t\t\t\t\t\t},\n\t\t\t\t\t);\n\t\t\t}\n\t\t\tif (!user) {\n\t\t\t\tthrow new APIError(\"INTERNAL_SERVER_ERROR\", {\n\t\t\t\t\tmessage: BASE_ERROR_CODES.FAILED_TO_UPDATE_USER,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tawait opts?.callbackOnVerification?.(\n\t\t\t\t{\n\t\t\t\t\tphoneNumber: ctx.body.phoneNumber,\n\t\t\t\t\tuser,\n\t\t\t\t},\n\t\t\t\tctx,\n\t\t\t);\n\n\t\t\tif (!ctx.body.disableSession) {\n\t\t\t\tconst session = await ctx.context.internalAdapter.createSession(\n\t\t\t\t\tuser.id,\n\t\t\t\t);\n\t\t\t\tif (!session) {\n\t\t\t\t\tthrow new APIError(\"INTERNAL_SERVER_ERROR\", {\n\t\t\t\t\t\tmessage: BASE_ERROR_CODES.FAILED_TO_CREATE_SESSION,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\tawait setSessionCookie(ctx, {\n\t\t\t\t\tsession,\n\t\t\t\t\tuser,\n\t\t\t\t});\n\t\t\t\treturn ctx.json({\n\t\t\t\t\tstatus: true,\n\t\t\t\t\ttoken: session.token,\n\t\t\t\t\tuser: parseUserOutput(ctx.context.options, user),\n\t\t\t\t});\n\t\t\t}\n\n\t\t\treturn ctx.json({\n\t\t\t\tstatus: true,\n\t\t\t\ttoken: null,\n\t\t\t\tuser: parseUserOutput(ctx.context.options, user),\n\t\t\t});\n\t\t},\n\t);\n\nconst requestPasswordResetPhoneNumberBodySchema = z.object({\n\tphoneNumber: z.string(),\n});\n\nexport const requestPasswordResetPhoneNumber = (\n\topts: RequiredPhoneNumberOptions,\n) =>\n\tcreateAuthEndpoint(\n\t\t\"/phone-number/request-password-reset\",\n\t\t{\n\t\t\tmethod: \"POST\",\n\t\t\tbody: requestPasswordResetPhoneNumberBodySchema,\n\t\t\tmetadata: {\n\t\t\t\topenapi: {\n\t\t\t\t\tdescription: \"Request OTP for password reset via phone number\",\n\t\t\t\t\tresponses: {\n\t\t\t\t\t\t\"200\": {\n\t\t\t\t\t\t\tdescription: \"OTP sent successfully for password reset\",\n\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\t\tstatus: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"boolean\",\n\t\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\"Indicates if the OTP was sent successfully\",\n\t\t\t\t\t\t\t\t\t\t\t\tenum: [true],\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\trequired: [\"status\"],\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t\tasync (ctx) => {\n\t\t\tconst user = await ctx.context.adapter.findOne<UserWithPhoneNumber>({\n\t\t\t\tmodel: \"user\",\n\t\t\t\twhere: [\n\t\t\t\t\t{\n\t\t\t\t\t\tvalue: ctx.body.phoneNumber,\n\t\t\t\t\t\tfield: opts.phoneNumber,\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t});\n\t\t\tconst code = generateOTP(opts.otpLength);\n\t\t\tawait ctx.context.internalAdapter.createVerificationValue({\n\t\t\t\tvalue: `${code}:0`,\n\t\t\t\tidentifier: `${ctx.body.phoneNumber}-request-password-reset`,\n\t\t\t\texpiresAt: getDate(opts.expiresIn, \"sec\"),\n\t\t\t});\n\t\t\t// to avoid leaking the existence of the phone number\n\t\t\tif (!user) {\n\t\t\t\treturn ctx.json({\n\t\t\t\t\tstatus: true,\n\t\t\t\t});\n\t\t\t}\n\t\t\tif (opts.sendPasswordResetOTP) {\n\t\t\t\tawait ctx.context.runInBackgroundOrAwait(\n\t\t\t\t\topts.sendPasswordResetOTP(\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tphoneNumber: ctx.body.phoneNumber,\n\t\t\t\t\t\t\tcode,\n\t\t\t\t\t\t},\n\t\t\t\t\t\tctx,\n\t\t\t\t\t),\n\t\t\t\t);\n\t\t\t}\n\t\t\treturn ctx.json({\n\t\t\t\tstatus: true,\n\t\t\t});\n\t\t},\n\t);\n\nconst resetPasswordPhoneNumberBodySchema = z.object({\n\totp: z.string().meta({\n\t\tdescription: 'The one time password to reset the password. Eg: \"123456\"',\n\t}),\n\tphoneNumber: z.string().meta({\n\t\tdescription:\n\t\t\t'The phone number to the account which intends to reset the password for. Eg: \"+1234567890\"',\n\t}),\n\tnewPassword: z.string().meta({\n\t\tdescription: `The new password. Eg: \"new-and-secure-password\"`,\n\t}),\n});\n\nexport const resetPasswordPhoneNumber = (opts: RequiredPhoneNumberOptions) =>\n\tcreateAuthEndpoint(\n\t\t\"/phone-number/reset-password\",\n\t\t{\n\t\t\tmethod: \"POST\",\n\t\t\tbody: resetPasswordPhoneNumberBodySchema,\n\t\t\tmetadata: {\n\t\t\t\topenapi: {\n\t\t\t\t\tdescription: \"Reset password using phone number OTP\",\n\t\t\t\t\tresponses: {\n\t\t\t\t\t\t\"200\": {\n\t\t\t\t\t\t\tdescription: \"Password reset successfully\",\n\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\t\tstatus: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"boolean\",\n\t\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\t\"Indicates if the password was reset successfully\",\n\t\t\t\t\t\t\t\t\t\t\t\tenum: [true],\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\trequired: [\"status\"],\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t\tasync (ctx) => {\n\t\t\tconst verification =\n\t\t\t\tawait ctx.context.internalAdapter.findVerificationValue(\n\t\t\t\t\t`${ctx.body.phoneNumber}-request-password-reset`,\n\t\t\t\t);\n\t\t\tif (!verification) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: PHONE_NUMBER_ERROR_CODES.OTP_NOT_FOUND,\n\t\t\t\t});\n\t\t\t}\n\t\t\tif (verification.expiresAt < new Date()) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: PHONE_NUMBER_ERROR_CODES.OTP_EXPIRED,\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst [otpValue, attempts] = verification.value.split(\":\");\n\t\t\tconst allowedAttempts = opts?.allowedAttempts || 3;\n\t\t\tif (attempts && parseInt(attempts) >= allowedAttempts) {\n\t\t\t\tawait ctx.context.internalAdapter.deleteVerificationValue(\n\t\t\t\t\tverification.id,\n\t\t\t\t);\n\t\t\t\tthrow new APIError(\"FORBIDDEN\", {\n\t\t\t\t\tmessage: PHONE_NUMBER_ERROR_CODES.TOO_MANY_ATTEMPTS,\n\t\t\t\t});\n\t\t\t}\n\t\t\tif (ctx.body.otp !== otpValue) {\n\t\t\t\tawait ctx.context.internalAdapter.updateVerificationValue(\n\t\t\t\t\tverification.id,\n\t\t\t\t\t{\n\t\t\t\t\t\tvalue: `${otpValue}:${parseInt(attempts || \"0\") + 1}`,\n\t\t\t\t\t},\n\t\t\t\t);\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: PHONE_NUMBER_ERROR_CODES.INVALID_OTP,\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst user = await ctx.context.adapter.findOne<User>({\n\t\t\t\tmodel: \"user\",\n\t\t\t\twhere: [\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"phoneNumber\",\n\t\t\t\t\t\tvalue: ctx.body.phoneNumber,\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t});\n\t\t\tif (!user) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: PHONE_NUMBER_ERROR_CODES.UNEXPECTED_ERROR,\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst minLength = ctx.context.password.config.minPasswordLength;\n\t\t\tconst maxLength = ctx.context.password.config.maxPasswordLength;\n\t\t\tif (ctx.body.newPassword.length < minLength) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: BASE_ERROR_CODES.PASSWORD_TOO_SHORT,\n\t\t\t\t});\n\t\t\t}\n\t\t\tif (ctx.body.newPassword.length > maxLength) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: BASE_ERROR_CODES.PASSWORD_TOO_LONG,\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst hashedPassword = await ctx.context.password.hash(\n\t\t\t\tctx.body.newPassword,\n\t\t\t);\n\t\t\tawait ctx.context.internalAdapter.updatePassword(user.id, hashedPassword);\n\t\t\tawait ctx.context.internalAdapter.deleteVerificationValue(\n\t\t\t\tverification.id,\n\t\t\t);\n\n\t\t\tif (ctx.context.options.emailAndPassword?.revokeSessionsOnPasswordReset) {\n\t\t\t\tawait ctx.context.internalAdapter.deleteSessions(user.id);\n\t\t\t}\n\n\t\t\treturn ctx.json({\n\t\t\t\tstatus: true,\n\t\t\t});\n\t\t},\n\t);\n\nfunction generateOTP(size: number) {\n\treturn generateRandomString(size, \"0-9\");\n}\n"],"mappings":"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"}