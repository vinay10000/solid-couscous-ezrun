{"version":3,"file":"access.mjs","names":[],"sources":["../../../src/plugins/access/access.ts"],"sourcesContent":["import { BetterAuthError } from \"@better-auth/core/error\";\nimport type { Statements, Subset } from \"./types\";\n\nexport type AuthorizeResponse =\n\t| { success: false; error: string }\n\t| { success: true; error?: never | undefined };\n\nexport function role<TStatements extends Statements>(statements: TStatements) {\n\treturn {\n\t\tauthorize<K extends keyof TStatements>(\n\t\t\trequest: {\n\t\t\t\t[key in K]?:\n\t\t\t\t\t| TStatements[key]\n\t\t\t\t\t| {\n\t\t\t\t\t\t\tactions: TStatements[key];\n\t\t\t\t\t\t\tconnector: \"OR\" | \"AND\";\n\t\t\t\t\t  };\n\t\t\t},\n\t\t\tconnector: \"OR\" | \"AND\" = \"AND\",\n\t\t): AuthorizeResponse {\n\t\t\tlet success = false;\n\t\t\tfor (const [requestedResource, requestedActions] of Object.entries(\n\t\t\t\trequest,\n\t\t\t)) {\n\t\t\t\tconst allowedActions = statements[requestedResource];\n\t\t\t\tif (!allowedActions) {\n\t\t\t\t\treturn {\n\t\t\t\t\t\tsuccess: false,\n\t\t\t\t\t\terror: `You are not allowed to access resource: ${requestedResource}`,\n\t\t\t\t\t};\n\t\t\t\t}\n\t\t\t\tif (Array.isArray(requestedActions)) {\n\t\t\t\t\tsuccess = (requestedActions as string[]).every((requestedAction) =>\n\t\t\t\t\t\tallowedActions.includes(requestedAction),\n\t\t\t\t\t);\n\t\t\t\t} else {\n\t\t\t\t\tif (typeof requestedActions === \"object\") {\n\t\t\t\t\t\tconst actions = requestedActions as {\n\t\t\t\t\t\t\tactions: string[];\n\t\t\t\t\t\t\tconnector: \"OR\" | \"AND\";\n\t\t\t\t\t\t};\n\t\t\t\t\t\tif (actions.connector === \"OR\") {\n\t\t\t\t\t\t\tsuccess = actions.actions.some((requestedAction) =>\n\t\t\t\t\t\t\t\tallowedActions.includes(requestedAction),\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tsuccess = actions.actions.every((requestedAction) =>\n\t\t\t\t\t\t\t\tallowedActions.includes(requestedAction),\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t}\n\t\t\t\t\t} else {\n\t\t\t\t\t\tthrow new BetterAuthError(\"Invalid access control request\");\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif (success && connector === \"OR\") {\n\t\t\t\t\treturn { success };\n\t\t\t\t}\n\t\t\t\tif (!success && connector === \"AND\") {\n\t\t\t\t\treturn {\n\t\t\t\t\t\tsuccess: false,\n\t\t\t\t\t\terror: `unauthorized to access resource \"${requestedResource}\"`,\n\t\t\t\t\t};\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (success) {\n\t\t\t\treturn {\n\t\t\t\t\tsuccess,\n\t\t\t\t};\n\t\t\t}\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: \"Not authorized\",\n\t\t\t};\n\t\t},\n\t\tstatements,\n\t};\n}\n\nexport function createAccessControl<const TStatements extends Statements>(\n\ts: TStatements,\n) {\n\treturn {\n\t\tnewRole<K extends keyof TStatements>(statements: Subset<K, TStatements>) {\n\t\t\treturn role<Subset<K, TStatements>>(statements);\n\t\t},\n\t\tstatements: s,\n\t};\n}\n"],"mappings":";;;AAOA,SAAgB,KAAqC,YAAyB;AAC7E,QAAO;EACN,UACC,SAQA,YAA0B,OACN;GACpB,IAAI,UAAU;AACd,QAAK,MAAM,CAAC,mBAAmB,qBAAqB,OAAO,QAC1D,QACA,EAAE;IACF,MAAM,iBAAiB,WAAW;AAClC,QAAI,CAAC,eACJ,QAAO;KACN,SAAS;KACT,OAAO,2CAA2C;KAClD;AAEF,QAAI,MAAM,QAAQ,iBAAiB,CAClC,WAAW,iBAA8B,OAAO,oBAC/C,eAAe,SAAS,gBAAgB,CACxC;aAEG,OAAO,qBAAqB,UAAU;KACzC,MAAM,UAAU;AAIhB,SAAI,QAAQ,cAAc,KACzB,WAAU,QAAQ,QAAQ,MAAM,oBAC/B,eAAe,SAAS,gBAAgB,CACxC;SAED,WAAU,QAAQ,QAAQ,OAAO,oBAChC,eAAe,SAAS,gBAAgB,CACxC;UAGF,OAAM,IAAI,gBAAgB,iCAAiC;AAG7D,QAAI,WAAW,cAAc,KAC5B,QAAO,EAAE,SAAS;AAEnB,QAAI,CAAC,WAAW,cAAc,MAC7B,QAAO;KACN,SAAS;KACT,OAAO,oCAAoC,kBAAkB;KAC7D;;AAGH,OAAI,QACH,QAAO,EACN,SACA;AAEF,UAAO;IACN,SAAS;IACT,OAAO;IACP;;EAEF;EACA;;AAGF,SAAgB,oBACf,GACC;AACD,QAAO;EACN,QAAqC,YAAoC;AACxE,UAAO,KAA6B,WAAW;;EAEhD,YAAY;EACZ"}