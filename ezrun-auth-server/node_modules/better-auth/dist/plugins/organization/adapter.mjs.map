{"version":3,"file":"adapter.mjs","names":["user","userId: string","member"],"sources":["../../../src/plugins/organization/adapter.ts"],"sourcesContent":["import type { AuthContext, GenericEndpointContext } from \"@better-auth/core\";\nimport { getCurrentAdapter } from \"@better-auth/core/context\";\nimport { BetterAuthError } from \"@better-auth/core/error\";\nimport { parseJSON } from \"../../client/parser\";\nimport type { InferAdditionalFieldsFromPluginOptions } from \"../../db\";\nimport type { Session, User } from \"../../types\";\nimport { getDate } from \"../../utils/date\";\nimport type {\n\tInferInvitation,\n\tInferMember,\n\tInferOrganization,\n\tInferTeam,\n\tInvitationInput,\n\tMember,\n\tMemberInput,\n\tOrganizationInput,\n\tTeam,\n\tTeamInput,\n\tTeamMember,\n} from \"./schema\";\nimport type { OrganizationOptions } from \"./types\";\n\nexport const getOrgAdapter = <O extends OrganizationOptions>(\n\tcontext: AuthContext,\n\toptions?: O | undefined,\n) => {\n\tconst baseAdapter = context.adapter;\n\treturn {\n\t\tfindOrganizationBySlug: async (slug: string) => {\n\t\t\tconst adapter = await getCurrentAdapter(baseAdapter);\n\t\t\tconst organization = await adapter.findOne<InferOrganization<O, false>>({\n\t\t\t\tmodel: \"organization\",\n\t\t\t\twhere: [\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"slug\",\n\t\t\t\t\t\tvalue: slug,\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t});\n\t\t\treturn organization;\n\t\t},\n\t\tcreateOrganization: async (data: {\n\t\t\torganization: OrganizationInput &\n\t\t\t\t// This represents the additional fields from the plugin options\n\t\t\t\tRecord<string, any>;\n\t\t}) => {\n\t\t\tconst adapter = await getCurrentAdapter(baseAdapter);\n\t\t\tconst organization = await adapter.create<\n\t\t\t\tOrganizationInput,\n\t\t\t\tInferOrganization<O, false>\n\t\t\t>({\n\t\t\t\tmodel: \"organization\",\n\t\t\t\tdata: {\n\t\t\t\t\t...data.organization,\n\t\t\t\t\tmetadata: data.organization.metadata\n\t\t\t\t\t\t? JSON.stringify(data.organization.metadata)\n\t\t\t\t\t\t: undefined,\n\t\t\t\t},\n\t\t\t\tforceAllowId: true,\n\t\t\t});\n\n\t\t\treturn {\n\t\t\t\t...organization,\n\t\t\t\tmetadata:\n\t\t\t\t\torganization.metadata && typeof organization.metadata === \"string\"\n\t\t\t\t\t\t? JSON.parse(organization.metadata)\n\t\t\t\t\t\t: undefined,\n\t\t\t} as typeof organization;\n\t\t},\n\t\tfindMemberByEmail: async (data: {\n\t\t\temail: string;\n\t\t\torganizationId: string;\n\t\t}) => {\n\t\t\tconst adapter = await getCurrentAdapter(baseAdapter);\n\t\t\tconst user = await adapter.findOne<User>({\n\t\t\t\tmodel: \"user\",\n\t\t\t\twhere: [\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"email\",\n\t\t\t\t\t\tvalue: data.email.toLowerCase(),\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t});\n\t\t\tif (!user) {\n\t\t\t\treturn null;\n\t\t\t}\n\t\t\tconst member = await adapter.findOne<InferMember<O, false>>({\n\t\t\t\tmodel: \"member\",\n\t\t\t\twhere: [\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"organizationId\",\n\t\t\t\t\t\tvalue: data.organizationId,\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"userId\",\n\t\t\t\t\t\tvalue: user.id,\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t});\n\t\t\tif (!member) {\n\t\t\t\treturn null;\n\t\t\t}\n\t\t\treturn {\n\t\t\t\t...member,\n\t\t\t\tuser: {\n\t\t\t\t\tid: user.id,\n\t\t\t\t\tname: user.name,\n\t\t\t\t\temail: user.email,\n\t\t\t\t\timage: user.image,\n\t\t\t\t},\n\t\t\t};\n\t\t},\n\t\tlistMembers: async (data: {\n\t\t\torganizationId?: string | undefined;\n\t\t\tlimit?: number | undefined;\n\t\t\toffset?: number | undefined;\n\t\t\tsortBy?: string | undefined;\n\t\t\tsortOrder?: (\"asc\" | \"desc\") | undefined;\n\t\t\tfilter?:\n\t\t\t\t| {\n\t\t\t\t\t\tfield: string;\n\t\t\t\t\t\toperator?: \"eq\" | \"ne\" | \"lt\" | \"lte\" | \"gt\" | \"gte\" | \"contains\";\n\t\t\t\t\t\tvalue: any;\n\t\t\t\t  }\n\t\t\t\t| undefined;\n\t\t}) => {\n\t\t\tconst adapter = await getCurrentAdapter(baseAdapter);\n\t\t\tconst members = await Promise.all([\n\t\t\t\tadapter.findMany<InferMember<O, false>>({\n\t\t\t\t\tmodel: \"member\",\n\t\t\t\t\twhere: [\n\t\t\t\t\t\t{ field: \"organizationId\", value: data.organizationId },\n\t\t\t\t\t\t...(data.filter?.field\n\t\t\t\t\t\t\t? [\n\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\tfield: data.filter?.field,\n\t\t\t\t\t\t\t\t\t\tvalue: data.filter?.value,\n\t\t\t\t\t\t\t\t\t\t...(data.filter.operator\n\t\t\t\t\t\t\t\t\t\t\t? { operator: data.filter.operator }\n\t\t\t\t\t\t\t\t\t\t\t: {}),\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t]\n\t\t\t\t\t\t\t: []),\n\t\t\t\t\t],\n\t\t\t\t\tlimit: data.limit || options?.membershipLimit || 100,\n\t\t\t\t\toffset: data.offset || 0,\n\t\t\t\t\tsortBy: data.sortBy\n\t\t\t\t\t\t? { field: data.sortBy, direction: data.sortOrder || \"asc\" }\n\t\t\t\t\t\t: undefined,\n\t\t\t\t}),\n\t\t\t\tadapter.count({\n\t\t\t\t\tmodel: \"member\",\n\t\t\t\t\twhere: [\n\t\t\t\t\t\t{ field: \"organizationId\", value: data.organizationId },\n\t\t\t\t\t\t...(data.filter?.field\n\t\t\t\t\t\t\t? [\n\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\tfield: data.filter?.field,\n\t\t\t\t\t\t\t\t\t\tvalue: data.filter?.value,\n\t\t\t\t\t\t\t\t\t\t...(data.filter.operator\n\t\t\t\t\t\t\t\t\t\t\t? { operator: data.filter.operator }\n\t\t\t\t\t\t\t\t\t\t\t: {}),\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t]\n\t\t\t\t\t\t\t: []),\n\t\t\t\t\t],\n\t\t\t\t}),\n\t\t\t]);\n\t\t\tconst users = await adapter.findMany<User>({\n\t\t\t\tmodel: \"user\",\n\t\t\t\twhere: [\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"id\",\n\t\t\t\t\t\tvalue: members[0].map((member) => member.userId),\n\t\t\t\t\t\toperator: \"in\",\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t});\n\t\t\treturn {\n\t\t\t\tmembers: members[0].map((member) => {\n\t\t\t\t\tconst user = users.find((user) => user.id === member.userId);\n\t\t\t\t\tif (!user) {\n\t\t\t\t\t\tthrow new BetterAuthError(\n\t\t\t\t\t\t\t\"Unexpected error: User not found for member\",\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t\treturn {\n\t\t\t\t\t\t...member,\n\t\t\t\t\t\tuser: {\n\t\t\t\t\t\t\tid: user.id,\n\t\t\t\t\t\t\tname: user.name,\n\t\t\t\t\t\t\temail: user.email,\n\t\t\t\t\t\t\timage: user.image,\n\t\t\t\t\t\t},\n\t\t\t\t\t};\n\t\t\t\t}),\n\t\t\t\ttotal: members[1],\n\t\t\t};\n\t\t},\n\t\tfindMemberByOrgId: async (data: {\n\t\t\tuserId: string;\n\t\t\torganizationId: string;\n\t\t}) => {\n\t\t\tconst adapter = await getCurrentAdapter(baseAdapter);\n\t\t\tconst result = await adapter.findOne<\n\t\t\t\tInferMember<O, false> & { user: User }\n\t\t\t>({\n\t\t\t\tmodel: \"member\",\n\t\t\t\twhere: [\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"userId\",\n\t\t\t\t\t\tvalue: data.userId,\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"organizationId\",\n\t\t\t\t\t\tvalue: data.organizationId,\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t\tjoin: {\n\t\t\t\t\tuser: true,\n\t\t\t\t},\n\t\t\t});\n\t\t\tif (!result || !result.user) return null;\n\t\t\tconst { user, ...member } = result;\n\n\t\t\treturn {\n\t\t\t\t...member,\n\t\t\t\tuser: {\n\t\t\t\t\tid: user.id,\n\t\t\t\t\tname: user.name,\n\t\t\t\t\temail: user.email,\n\t\t\t\t\timage: user.image,\n\t\t\t\t},\n\t\t\t};\n\t\t},\n\t\tfindMemberById: async (memberId: string) => {\n\t\t\tconst adapter = await getCurrentAdapter(baseAdapter);\n\t\t\tconst result = await adapter.findOne<\n\t\t\t\tInferMember<O, false> & { user: User }\n\t\t\t>({\n\t\t\t\tmodel: \"member\",\n\t\t\t\twhere: [\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"id\",\n\t\t\t\t\t\tvalue: memberId,\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t\tjoin: {\n\t\t\t\t\tuser: true,\n\t\t\t\t},\n\t\t\t});\n\t\t\tif (!result) {\n\t\t\t\treturn null;\n\t\t\t}\n\t\t\tconst { user, ...member } = result;\n\n\t\t\treturn {\n\t\t\t\t...(member as unknown as InferMember<O, false>),\n\t\t\t\tuser: {\n\t\t\t\t\tid: user.id,\n\t\t\t\t\tname: user.name,\n\t\t\t\t\temail: user.email,\n\t\t\t\t\timage: user.image,\n\t\t\t\t},\n\t\t\t};\n\t\t},\n\t\tcreateMember: async (\n\t\t\tdata: Omit<MemberInput, \"id\"> &\n\t\t\t\t// Additional fields from the plugin options\n\t\t\t\tRecord<string, any>,\n\t\t) => {\n\t\t\tconst adapter = await getCurrentAdapter(baseAdapter);\n\t\t\tconst member = await adapter.create<\n\t\t\t\ttypeof data,\n\t\t\t\tMember & InferAdditionalFieldsFromPluginOptions<\"member\", O, false>\n\t\t\t>({\n\t\t\t\tmodel: \"member\",\n\t\t\t\tdata: {\n\t\t\t\t\t...data,\n\t\t\t\t\tcreatedAt: new Date(),\n\t\t\t\t},\n\t\t\t});\n\t\t\treturn member;\n\t\t},\n\t\tupdateMember: async (memberId: string, role: string) => {\n\t\t\tconst adapter = await getCurrentAdapter(baseAdapter);\n\t\t\tconst member = await adapter.update<InferMember<O, false>>({\n\t\t\t\tmodel: \"member\",\n\t\t\t\twhere: [\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"id\",\n\t\t\t\t\t\tvalue: memberId,\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t\tupdate: {\n\t\t\t\t\trole,\n\t\t\t\t},\n\t\t\t});\n\t\t\treturn member;\n\t\t},\n\t\tdeleteMember: async ({\n\t\t\tmemberId,\n\t\t\torganizationId,\n\t\t\tuserId: _userId,\n\t\t}: {\n\t\t\tmemberId: string;\n\t\t\torganizationId: string;\n\t\t\tuserId?: string;\n\t\t}) => {\n\t\t\tconst adapter = await getCurrentAdapter(baseAdapter);\n\t\t\tlet userId: string;\n\t\t\tif (!_userId) {\n\t\t\t\tconst member = await adapter.findOne<Member>({\n\t\t\t\t\tmodel: \"member\",\n\t\t\t\t\twhere: [{ field: \"id\", value: memberId }],\n\t\t\t\t});\n\t\t\t\tif (!member) {\n\t\t\t\t\tthrow new BetterAuthError(\"Member not found\");\n\t\t\t\t}\n\t\t\t\tuserId = member.userId;\n\t\t\t} else {\n\t\t\t\tuserId = _userId;\n\t\t\t}\n\t\t\tconst member = await adapter.delete<InferMember<O, false>>({\n\t\t\t\tmodel: \"member\",\n\t\t\t\twhere: [\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"id\",\n\t\t\t\t\t\tvalue: memberId,\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t});\n\t\t\t// remove member from all teams they're part of\n\t\t\tif (options?.teams?.enabled) {\n\t\t\t\tconst teams = await adapter.findMany<Team>({\n\t\t\t\t\tmodel: \"team\",\n\t\t\t\t\twhere: [{ field: \"organizationId\", value: organizationId }],\n\t\t\t\t});\n\t\t\t\tawait Promise.all(\n\t\t\t\t\tteams.map((team) =>\n\t\t\t\t\t\tadapter.deleteMany({\n\t\t\t\t\t\t\tmodel: \"teamMember\",\n\t\t\t\t\t\t\twhere: [\n\t\t\t\t\t\t\t\t{ field: \"teamId\", value: team.id },\n\t\t\t\t\t\t\t\t{ field: \"userId\", value: userId },\n\t\t\t\t\t\t\t],\n\t\t\t\t\t\t}),\n\t\t\t\t\t),\n\t\t\t\t);\n\t\t\t}\n\t\t\treturn member;\n\t\t},\n\t\tupdateOrganization: async (\n\t\t\torganizationId: string,\n\t\t\tdata: Partial<OrganizationInput>,\n\t\t) => {\n\t\t\tconst adapter = await getCurrentAdapter(baseAdapter);\n\t\t\tconst organization = await adapter.update<InferOrganization<O, false>>({\n\t\t\t\tmodel: \"organization\",\n\t\t\t\twhere: [\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"id\",\n\t\t\t\t\t\tvalue: organizationId,\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t\tupdate: {\n\t\t\t\t\t...data,\n\t\t\t\t\tmetadata:\n\t\t\t\t\t\ttypeof data.metadata === \"object\"\n\t\t\t\t\t\t\t? JSON.stringify(data.metadata)\n\t\t\t\t\t\t\t: data.metadata,\n\t\t\t\t},\n\t\t\t});\n\t\t\tif (!organization) {\n\t\t\t\treturn null;\n\t\t\t}\n\t\t\treturn {\n\t\t\t\t...organization,\n\t\t\t\tmetadata: organization.metadata\n\t\t\t\t\t? parseJSON<Record<string, any>>(organization.metadata)\n\t\t\t\t\t: undefined,\n\t\t\t};\n\t\t},\n\t\tdeleteOrganization: async (organizationId: string) => {\n\t\t\tconst adapter = await getCurrentAdapter(baseAdapter);\n\t\t\tawait adapter.deleteMany({\n\t\t\t\tmodel: \"member\",\n\t\t\t\twhere: [\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"organizationId\",\n\t\t\t\t\t\tvalue: organizationId,\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t});\n\t\t\tawait adapter.deleteMany({\n\t\t\t\tmodel: \"invitation\",\n\t\t\t\twhere: [\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"organizationId\",\n\t\t\t\t\t\tvalue: organizationId,\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t});\n\t\t\tawait adapter.delete<InferOrganization<O, false>>({\n\t\t\t\tmodel: \"organization\",\n\t\t\t\twhere: [\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"id\",\n\t\t\t\t\t\tvalue: organizationId,\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t});\n\t\t\treturn organizationId;\n\t\t},\n\t\tsetActiveOrganization: async (\n\t\t\tsessionToken: string,\n\t\t\torganizationId: string | null,\n\t\t\tctx: GenericEndpointContext,\n\t\t) => {\n\t\t\tconst session = await context.internalAdapter.updateSession(\n\t\t\t\tsessionToken,\n\t\t\t\t{\n\t\t\t\t\tactiveOrganizationId: organizationId,\n\t\t\t\t},\n\t\t\t);\n\t\t\treturn session as Session;\n\t\t},\n\t\tfindOrganizationById: async (organizationId: string) => {\n\t\t\tconst adapter = await getCurrentAdapter(baseAdapter);\n\t\t\tconst organization = await adapter.findOne<InferOrganization<O, false>>({\n\t\t\t\tmodel: \"organization\",\n\t\t\t\twhere: [\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"id\",\n\t\t\t\t\t\tvalue: organizationId,\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t});\n\t\t\treturn organization;\n\t\t},\n\t\tcheckMembership: async ({\n\t\t\tuserId,\n\t\t\torganizationId,\n\t\t}: {\n\t\t\tuserId: string;\n\t\t\torganizationId: string;\n\t\t}) => {\n\t\t\tconst adapter = await getCurrentAdapter(baseAdapter);\n\t\t\tconst member = await adapter.findOne<InferMember<O, false>>({\n\t\t\t\tmodel: \"member\",\n\t\t\t\twhere: [\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"userId\",\n\t\t\t\t\t\tvalue: userId,\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"organizationId\",\n\t\t\t\t\t\tvalue: organizationId,\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t});\n\t\t\treturn member;\n\t\t},\n\t\t/**\n\t\t * @requires db\n\t\t */\n\t\tfindFullOrganization: async ({\n\t\t\torganizationId,\n\t\t\tisSlug,\n\t\t\tincludeTeams,\n\t\t\tmembersLimit,\n\t\t}: {\n\t\t\torganizationId: string;\n\t\t\tisSlug?: boolean | undefined;\n\t\t\tincludeTeams?: boolean | undefined;\n\t\t\tmembersLimit?: number | undefined;\n\t\t}) => {\n\t\t\tconst adapter = await getCurrentAdapter(baseAdapter);\n\t\t\tconst result = await adapter.findOne<\n\t\t\t\tInferOrganization<O, false> & {\n\t\t\t\t\tinvitation: InferInvitation<O>[];\n\t\t\t\t\tmember: InferMember<O>[];\n\t\t\t\t\tteam: InferTeam<O>[] | undefined;\n\t\t\t\t}\n\t\t\t>({\n\t\t\t\tmodel: \"organization\",\n\t\t\t\twhere: [{ field: isSlug ? \"slug\" : \"id\", value: organizationId }],\n\t\t\t\tjoin: {\n\t\t\t\t\tinvitation: true,\n\t\t\t\t\tmember: membersLimit ? { limit: membersLimit } : true,\n\t\t\t\t\t...(includeTeams ? { team: true } : {}),\n\t\t\t\t},\n\t\t\t});\n\t\t\tif (!result) {\n\t\t\t\treturn null;\n\t\t\t}\n\n\t\t\tconst {\n\t\t\t\tinvitation: invitations,\n\t\t\t\tmember: members,\n\t\t\t\tteam: teams,\n\t\t\t\t...org\n\t\t\t} = result;\n\t\t\tconst userIds = members.map((member) => member.userId);\n\t\t\tconst users =\n\t\t\t\tuserIds.length > 0\n\t\t\t\t\t? await adapter.findMany<User>({\n\t\t\t\t\t\t\tmodel: \"user\",\n\t\t\t\t\t\t\twhere: [{ field: \"id\", value: userIds, operator: \"in\" }],\n\t\t\t\t\t\t\tlimit: options?.membershipLimit || 100,\n\t\t\t\t\t\t})\n\t\t\t\t\t: [];\n\n\t\t\tconst userMap = new Map(users.map((user) => [user.id, user]));\n\t\t\tconst membersWithUsers = members.map((member) => {\n\t\t\t\tconst user = userMap.get(member.userId);\n\t\t\t\tif (!user) {\n\t\t\t\t\tthrow new BetterAuthError(\n\t\t\t\t\t\t\"Unexpected error: User not found for member\",\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\treturn {\n\t\t\t\t\t...member,\n\t\t\t\t\tuser: {\n\t\t\t\t\t\tid: user.id,\n\t\t\t\t\t\tname: user.name,\n\t\t\t\t\t\temail: user.email,\n\t\t\t\t\t\timage: user.image,\n\t\t\t\t\t},\n\t\t\t\t};\n\t\t\t});\n\n\t\t\treturn {\n\t\t\t\t...org,\n\t\t\t\tinvitations,\n\t\t\t\tmembers: membersWithUsers,\n\t\t\t\tteams,\n\t\t\t};\n\t\t},\n\t\tlistOrganizations: async (userId: string) => {\n\t\t\tconst adapter = await getCurrentAdapter(baseAdapter);\n\t\t\tconst result = await adapter.findMany<\n\t\t\t\tInferMember<O, false> & { organization: InferOrganization<O, false> }\n\t\t\t>({\n\t\t\t\tmodel: \"member\",\n\t\t\t\twhere: [\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"userId\",\n\t\t\t\t\t\tvalue: userId,\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t\tjoin: {\n\t\t\t\t\torganization: true,\n\t\t\t\t},\n\t\t\t});\n\n\t\t\tif (!result || result.length === 0) {\n\t\t\t\treturn [];\n\t\t\t}\n\n\t\t\tconst organizations = result.map((member) => member.organization);\n\n\t\t\treturn organizations;\n\t\t},\n\t\tcreateTeam: async (data: Omit<TeamInput, \"id\">) => {\n\t\t\tconst adapter = await getCurrentAdapter(baseAdapter);\n\t\t\tconst team = await adapter.create<\n\t\t\t\tOmit<TeamInput, \"id\">,\n\t\t\t\tInferTeam<O, false>\n\t\t\t>({\n\t\t\t\tmodel: \"team\",\n\t\t\t\tdata,\n\t\t\t});\n\t\t\treturn team;\n\t\t},\n\t\tfindTeamById: async <IncludeMembers extends boolean>({\n\t\t\tteamId,\n\t\t\torganizationId,\n\t\t\tincludeTeamMembers,\n\t\t}: {\n\t\t\tteamId: string;\n\t\t\torganizationId?: string | undefined;\n\t\t\tincludeTeamMembers?: IncludeMembers | undefined;\n\t\t}): Promise<\n\t\t\t| (InferTeam<O> &\n\t\t\t\t\t(IncludeMembers extends true ? { members: TeamMember[] } : {}))\n\t\t\t| null\n\t\t> => {\n\t\t\tconst adapter = await getCurrentAdapter(baseAdapter);\n\t\t\tconst result = await adapter.findOne<\n\t\t\t\tInferTeam<O> & { teamMember: TeamMember[] }\n\t\t\t>({\n\t\t\t\tmodel: \"team\",\n\t\t\t\twhere: [\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"id\",\n\t\t\t\t\t\tvalue: teamId,\n\t\t\t\t\t},\n\t\t\t\t\t...(organizationId\n\t\t\t\t\t\t? [\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tfield: \"organizationId\",\n\t\t\t\t\t\t\t\t\tvalue: organizationId,\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t]\n\t\t\t\t\t\t: []),\n\t\t\t\t],\n\t\t\t\tjoin: {\n\t\t\t\t\t// In the future when `join` support is better, we can apply the `membershipLimit` here. Right now we're just querying 100.\n\t\t\t\t\t...(includeTeamMembers ? { teamMember: true } : {}),\n\t\t\t\t},\n\t\t\t});\n\t\t\tif (!result) {\n\t\t\t\treturn null;\n\t\t\t}\n\t\t\tconst { teamMember, ...team } = result;\n\n\t\t\treturn {\n\t\t\t\t...team,\n\t\t\t\t...(includeTeamMembers ? { members: teamMember } : {}),\n\t\t\t} as any;\n\t\t},\n\t\tupdateTeam: async (\n\t\t\tteamId: string,\n\t\t\tdata: {\n\t\t\t\tname?: string | undefined;\n\t\t\t\tdescription?: string | undefined;\n\t\t\t\tstatus?: string | undefined;\n\t\t\t},\n\t\t) => {\n\t\t\tconst adapter = await getCurrentAdapter(baseAdapter);\n\t\t\tif (\"id\" in data) data.id = undefined;\n\t\t\tconst team = await adapter.update<\n\t\t\t\tInferTeam<O, false> & InferAdditionalFieldsFromPluginOptions<\"team\", O>\n\t\t\t>({\n\t\t\t\tmodel: \"team\",\n\t\t\t\twhere: [\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"id\",\n\t\t\t\t\t\tvalue: teamId,\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t\tupdate: {\n\t\t\t\t\t...data,\n\t\t\t\t},\n\t\t\t});\n\t\t\treturn team;\n\t\t},\n\n\t\tdeleteTeam: async (teamId: string) => {\n\t\t\tconst adapter = await getCurrentAdapter(baseAdapter);\n\t\t\tawait adapter.deleteMany({\n\t\t\t\tmodel: \"teamMember\",\n\t\t\t\twhere: [\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"teamId\",\n\t\t\t\t\t\tvalue: teamId,\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t});\n\n\t\t\tconst team = await adapter.delete<InferTeam<O, false>>({\n\t\t\t\tmodel: \"team\",\n\t\t\t\twhere: [\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"id\",\n\t\t\t\t\t\tvalue: teamId,\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t});\n\t\t\treturn team;\n\t\t},\n\n\t\tlistTeams: async (organizationId: string) => {\n\t\t\tconst adapter = await getCurrentAdapter(baseAdapter);\n\t\t\tconst teams = await adapter.findMany<InferTeam<O, false>>({\n\t\t\t\tmodel: \"team\",\n\t\t\t\twhere: [\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"organizationId\",\n\t\t\t\t\t\tvalue: organizationId,\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t});\n\t\t\treturn teams;\n\t\t},\n\n\t\tcreateTeamInvitation: async ({\n\t\t\temail,\n\t\t\trole,\n\t\t\tteamId,\n\t\t\torganizationId,\n\t\t\tinviterId,\n\t\t\texpiresIn = 1000 * 60 * 60 * 48, // Default expiration: 48 hours\n\t\t}: {\n\t\t\temail: string;\n\t\t\trole: string;\n\t\t\tteamId: string;\n\t\t\torganizationId: string;\n\t\t\tinviterId: string;\n\t\t\texpiresIn?: number | undefined;\n\t\t}) => {\n\t\t\tconst adapter = await getCurrentAdapter(baseAdapter);\n\t\t\tconst expiresAt = getDate(expiresIn); // Get expiration date\n\n\t\t\tconst invitation = await adapter.create<\n\t\t\t\tInvitationInput,\n\t\t\t\tInferInvitation<O>\n\t\t\t>({\n\t\t\t\tmodel: \"invitation\",\n\t\t\t\tdata: {\n\t\t\t\t\temail,\n\t\t\t\t\trole,\n\t\t\t\t\torganizationId,\n\t\t\t\t\tteamId,\n\t\t\t\t\tinviterId,\n\t\t\t\t\tstatus: \"pending\",\n\t\t\t\t\texpiresAt,\n\t\t\t\t},\n\t\t\t});\n\n\t\t\treturn invitation;\n\t\t},\n\n\t\tsetActiveTeam: async (\n\t\t\tsessionToken: string,\n\t\t\tteamId: string | null,\n\t\t\tctx: GenericEndpointContext,\n\t\t) => {\n\t\t\tconst session = await context.internalAdapter.updateSession(\n\t\t\t\tsessionToken,\n\t\t\t\t{\n\t\t\t\t\tactiveTeamId: teamId,\n\t\t\t\t},\n\t\t\t);\n\t\t\treturn session as Session;\n\t\t},\n\n\t\tlistTeamMembers: async (data: { teamId: string }) => {\n\t\t\tconst adapter = await getCurrentAdapter(baseAdapter);\n\t\t\tconst members = await adapter.findMany<TeamMember>({\n\t\t\t\tmodel: \"teamMember\",\n\t\t\t\twhere: [\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"teamId\",\n\t\t\t\t\t\tvalue: data.teamId,\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t});\n\n\t\t\treturn members;\n\t\t},\n\t\tcountTeamMembers: async (data: { teamId: string }) => {\n\t\t\tconst adapter = await getCurrentAdapter(baseAdapter);\n\t\t\tconst count = await adapter.count({\n\t\t\t\tmodel: \"teamMember\",\n\t\t\t\twhere: [{ field: \"teamId\", value: data.teamId }],\n\t\t\t});\n\t\t\treturn count;\n\t\t},\n\t\tcountMembers: async (data: { organizationId: string }) => {\n\t\t\tconst adapter = await getCurrentAdapter(baseAdapter);\n\t\t\tconst count = await adapter.count({\n\t\t\t\tmodel: \"member\",\n\t\t\t\twhere: [{ field: \"organizationId\", value: data.organizationId }],\n\t\t\t});\n\t\t\treturn count;\n\t\t},\n\t\tlistTeamsByUser: async (data: { userId: string }) => {\n\t\t\tconst adapter = await getCurrentAdapter(baseAdapter);\n\t\t\tconst results = await adapter.findMany<TeamMember & { team: Team }>({\n\t\t\t\tmodel: \"teamMember\",\n\t\t\t\twhere: [\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"userId\",\n\t\t\t\t\t\tvalue: data.userId,\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t\tjoin: {\n\t\t\t\t\tteam: true,\n\t\t\t\t},\n\t\t\t});\n\n\t\t\treturn results.map((result) => result.team);\n\t\t},\n\n\t\tfindTeamMember: async (data: { teamId: string; userId: string }) => {\n\t\t\tconst adapter = await getCurrentAdapter(baseAdapter);\n\t\t\tconst member = await adapter.findOne<TeamMember>({\n\t\t\t\tmodel: \"teamMember\",\n\t\t\t\twhere: [\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"teamId\",\n\t\t\t\t\t\tvalue: data.teamId,\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"userId\",\n\t\t\t\t\t\tvalue: data.userId,\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t});\n\n\t\t\treturn member;\n\t\t},\n\n\t\tfindOrCreateTeamMember: async (data: {\n\t\t\tteamId: string;\n\t\t\tuserId: string;\n\t\t}) => {\n\t\t\tconst adapter = await getCurrentAdapter(baseAdapter);\n\t\t\tconst member = await adapter.findOne<TeamMember>({\n\t\t\t\tmodel: \"teamMember\",\n\t\t\t\twhere: [\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"teamId\",\n\t\t\t\t\t\tvalue: data.teamId,\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"userId\",\n\t\t\t\t\t\tvalue: data.userId,\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t});\n\n\t\t\tif (member) return member;\n\n\t\t\treturn await adapter.create<Omit<TeamMember, \"id\">, TeamMember>({\n\t\t\t\tmodel: \"teamMember\",\n\t\t\t\tdata: {\n\t\t\t\t\tteamId: data.teamId,\n\t\t\t\t\tuserId: data.userId,\n\t\t\t\t\tcreatedAt: new Date(),\n\t\t\t\t},\n\t\t\t});\n\t\t},\n\t\tremoveTeamMember: async (data: { teamId: string; userId: string }) => {\n\t\t\tconst adapter = await getCurrentAdapter(baseAdapter);\n\t\t\t// use `deleteMany` instead of `delete` since Prisma requires 1 unique field for normal `delete` operations\n\t\t\t// FKs do not count thus breaking the operation. As a solution, we'll use `deleteMany` instead.\n\t\t\tawait adapter.deleteMany({\n\t\t\t\tmodel: \"teamMember\",\n\t\t\t\twhere: [\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"teamId\",\n\t\t\t\t\t\tvalue: data.teamId,\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"userId\",\n\t\t\t\t\t\tvalue: data.userId,\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t});\n\t\t},\n\t\tfindInvitationsByTeamId: async (teamId: string) => {\n\t\t\tconst adapter = await getCurrentAdapter(baseAdapter);\n\t\t\tconst invitations = await adapter.findMany<InferInvitation<O, false>>({\n\t\t\t\tmodel: \"invitation\",\n\t\t\t\twhere: [\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"teamId\",\n\t\t\t\t\t\tvalue: teamId,\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t});\n\t\t\treturn invitations;\n\t\t},\n\t\tlistUserInvitations: async (email: string) => {\n\t\t\tconst adapter = await getCurrentAdapter(baseAdapter);\n\t\t\tconst invitations = await adapter.findMany<\n\t\t\t\tInferInvitation<O, false> & {\n\t\t\t\t\torganization: InferOrganization<O, false>;\n\t\t\t\t}\n\t\t\t>({\n\t\t\t\tmodel: \"invitation\",\n\t\t\t\twhere: [{ field: \"email\", value: email.toLowerCase() }],\n\t\t\t\tjoin: {\n\t\t\t\t\torganization: true,\n\t\t\t\t},\n\t\t\t});\n\t\t\treturn invitations.map(({ organization, ...inv }) => ({\n\t\t\t\t...inv,\n\t\t\t\torganizationName: organization.name,\n\t\t\t}));\n\t\t},\n\t\tcreateInvitation: async ({\n\t\t\tinvitation,\n\t\t\tuser,\n\t\t}: {\n\t\t\tinvitation: {\n\t\t\t\temail: string;\n\t\t\t\trole: string;\n\t\t\t\torganizationId: string;\n\t\t\t\tteamIds: string[];\n\t\t\t} & Record<string, any>; // This represents the additionalFields for the invitation\n\t\t\tuser: User;\n\t\t}) => {\n\t\t\tconst adapter = await getCurrentAdapter(baseAdapter);\n\t\t\tconst defaultExpiration = 60 * 60 * 48;\n\t\t\tconst expiresAt = getDate(\n\t\t\t\toptions?.invitationExpiresIn || defaultExpiration,\n\t\t\t\t\"sec\",\n\t\t\t);\n\t\t\tconst invite = await adapter.create<\n\t\t\t\tOmit<InvitationInput, \"id\">,\n\t\t\t\tInferInvitation<O, false>\n\t\t\t>({\n\t\t\t\tmodel: \"invitation\",\n\t\t\t\tdata: {\n\t\t\t\t\tstatus: \"pending\",\n\t\t\t\t\texpiresAt,\n\t\t\t\t\tcreatedAt: new Date(),\n\t\t\t\t\tinviterId: user.id,\n\t\t\t\t\t...invitation,\n\t\t\t\t\tteamId:\n\t\t\t\t\t\tinvitation.teamIds.length > 0 ? invitation.teamIds.join(\",\") : null,\n\t\t\t\t},\n\t\t\t});\n\n\t\t\treturn invite;\n\t\t},\n\t\tfindInvitationById: async (id: string) => {\n\t\t\tconst adapter = await getCurrentAdapter(baseAdapter);\n\t\t\tconst invitation = await adapter.findOne<InferInvitation<O, false>>({\n\t\t\t\tmodel: \"invitation\",\n\t\t\t\twhere: [\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"id\",\n\t\t\t\t\t\tvalue: id,\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t});\n\t\t\treturn invitation;\n\t\t},\n\t\tfindPendingInvitation: async (data: {\n\t\t\temail: string;\n\t\t\torganizationId: string;\n\t\t}) => {\n\t\t\tconst adapter = await getCurrentAdapter(baseAdapter);\n\t\t\tconst invitation = await adapter.findMany<InferInvitation<O, false>>({\n\t\t\t\tmodel: \"invitation\",\n\t\t\t\twhere: [\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"email\",\n\t\t\t\t\t\tvalue: data.email.toLowerCase(),\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"organizationId\",\n\t\t\t\t\t\tvalue: data.organizationId,\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"status\",\n\t\t\t\t\t\tvalue: \"pending\",\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t});\n\t\t\treturn invitation.filter(\n\t\t\t\t(invite) => new Date(invite.expiresAt) > new Date(),\n\t\t\t);\n\t\t},\n\t\tfindPendingInvitations: async (data: { organizationId: string }) => {\n\t\t\tconst adapter = await getCurrentAdapter(baseAdapter);\n\t\t\tconst invitations = await adapter.findMany<InferInvitation<O, false>>({\n\t\t\t\tmodel: \"invitation\",\n\t\t\t\twhere: [\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"organizationId\",\n\t\t\t\t\t\tvalue: data.organizationId,\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"status\",\n\t\t\t\t\t\tvalue: \"pending\",\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t});\n\t\t\treturn invitations.filter(\n\t\t\t\t(invite) => new Date(invite.expiresAt) > new Date(),\n\t\t\t);\n\t\t},\n\t\tlistInvitations: async (data: { organizationId: string }) => {\n\t\t\tconst adapter = await getCurrentAdapter(baseAdapter);\n\t\t\tconst invitations = await adapter.findMany<InferInvitation<O, false>>({\n\t\t\t\tmodel: \"invitation\",\n\t\t\t\twhere: [\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"organizationId\",\n\t\t\t\t\t\tvalue: data.organizationId,\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t});\n\t\t\treturn invitations;\n\t\t},\n\t\tupdateInvitation: async (data: {\n\t\t\tinvitationId: string;\n\t\t\tstatus: \"accepted\" | \"canceled\" | \"rejected\";\n\t\t}) => {\n\t\t\tconst adapter = await getCurrentAdapter(baseAdapter);\n\t\t\tconst invitation = await adapter.update<InferInvitation<O, false>>({\n\t\t\t\tmodel: \"invitation\",\n\t\t\t\twhere: [\n\t\t\t\t\t{\n\t\t\t\t\t\tfield: \"id\",\n\t\t\t\t\t\tvalue: data.invitationId,\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t\tupdate: {\n\t\t\t\t\tstatus: data.status,\n\t\t\t\t},\n\t\t\t});\n\t\t\treturn invitation;\n\t\t},\n\t};\n};\n"],"mappings":"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"}